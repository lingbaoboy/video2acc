# video2acc
一个用ai编写的python程序，基于ffmpeg,将视频中的音频批量分离，也可转码。

代码质量不知道咋样，ai写的，反正可以跑起来，Windows和macos通过编译，Linux没测试过，软件不联网。
如果需要自己编译除了仓库中4个py文件，3个图标文件外，还需要在项目文件夹创建一个ffmpeg文件夹，下载ffmpeg和ffprobe放入这个文件夹，linux和mac不需要后缀，但是需要设置执行权限，win命名为ffmpeg.exe和ffprobe.exe
然后安装依赖，就可以打包了

## 需求整理与逻辑关系（日志与多编码支持版）

您需要开发一个基于 FFmpeg 的 GUI 软件，用于处理用户的多媒体文件（视频或音频）。核心功能是音频提取和重新编码，并支持多音轨处理、多种输出编码格式以及详细的日志记录。

-----

### 1\. GUI 界面设计要点

  * **文件选择区：**
      * 允许用户**多选**视频或音频格式文件（例如 MP4, MKV, AVI, MP3, WAV, FLAC, AAC 等）。
  * **输出选项区：**
      * 提供两个主要处理选项：
          * **直接提取音频：** 尽可能不重新编码，直接提取原始音频轨道。
          * **重新编码音频：** 对音频轨道进行重新编码。
  * **编码参数设置区：**
      * 此区域默认可隐藏或禁用。
      * **何时显示/启用：**
        1.  当用户选择\*\*“重新编码音频”**时，此区域**必须立即显示并启用\*\*。
        2.  当用户选择\*\*“直接提取音频”\*\*后，**如果软件检测到所选文件（或批处理中的任何文件）不包含 AAC 音频轨道时，此区域也必须立即显示并启用**，并提示用户这些非 AAC 音频将需要被编码。
      * **编码格式选择（新增）：** 在此区域内，当需要重新编码时（无论是选择“重新编码音频”还是“直接提取”且源非 AAC），应提供一个下拉列表或单选按钮组，允许用户选择**常见的音频编码格式**，例如：
          * **AAC** (默认或推荐)
          * **MP3**
          * **Opus**
          * **FLAC** (无损)
          * **AC3** (如果需要，常用于多声道)
      * **通用编码参数：** 根据所选编码格式，提供相应的参数设置，如：
          * 比特率（Bitrate）
          * 质量（Quality VBR/CRF）
          * 采样率（Sample Rate）
          * 声道数（Channels）
  * **多音轨选择/显示：**
      * 在文件选择后，或在分析阶段，**GUI 应该显示检测到的每个文件的音轨数量和基本信息**（例如，编码格式、语言标签）。
      * **默认行为：** 默认处理所有检测到的音轨。
  * **日志显示区（新增）：**
      * 在 GUI 界面上应有一个区域（例如一个文本框或列表），用于**实时显示处理日志**。

-----

### 2\. 核心逻辑（FFmpeg 处理流程）

1.  **文件迭代：** 软件将逐一处理用户选择的每个多媒体文件。

2.  **音频轨道分析（增强）：** 对于每个输入文件，软件首先使用 FFmpeg 的 `ffprobe` 工具分析，**识别出所有音频轨道**。

      * 对于每个音轨，判断其**是否为 AAC 编码格式**，并确定其**原始编码格式**（例如 MP3, AC3, FLAC, PCM 等）及其对应的常见文件后缀。
      * **重要：** 记录每个音轨的索引（例如 `stream_id:a:0`, `stream_id:a:1` 等）以及**原始的编码器名称**。

3.  **根据用户选择和每个音轨的分析结果执行操作：**

      * **场景一：用户选择了“直接提取音频”**

          * **对于当前文件的每一个音频轨道：**
              * **如果该音轨是 AAC 编码：**
                  * **步骤 1 (直接提取):** 直接使用 FFmpeg 的流复制功能（`-c:a copy`）将该 **AAC 音轨无损提取出来**。
                  * **输出文件名：** 命名为 `原始文件名-音轨序号.m4a`。
                  * **日志记录：** 记录成功信息，包括原始文件、音轨索引、输出文件名以及操作类型（“直接提取 AAC”）。
              * **如果该音轨不是 AAC 编码：**
                  * **步骤 1 (无损提取原始音频):** 首先，使用 FFmpeg 的流复制功能（`-c:a copy -map 0:a:N`）将原始音频轨道**无损地单独提取出来**。
                      * 文件后缀应使用其原始编码格式的常见后缀（根据 `ffprobe` 获取的 `codec_name` 决定，例如 `.mp3` for MP3, `.ac3` for AC3, `.wav` for PCM, `.flac` for FLAC 等）。
                      * **输出文件名：** 命名为 `原始文件名-音轨序号.原始后缀`。这将作为原始音频的备份。
                      * **日志记录：** 记录成功信息，包括原始文件、音轨索引、无损提取的文件名。
                  * **步骤 2 (重新编码为用户选择的格式):** 接着，**使用 GUI 中用户设置的编码格式和参数**，对**上一步无损提取出的音频文件**进行重新编码。
                      * **输出文件名：** 命名为 `原始文件名-音轨序号.新格式后缀`（例如 `.mp3`, `.opus`, `.flac` 等）。
                      * **日志记录：** 记录成功信息，包括原始文件、音轨索引、最终输出文件名以及操作类型（“无损提取后重新编码为 [格式]”）。
                  * *(GUI 必须在此场景下引导用户设置编码格式和参数)*

      * **场景二：用户选择了“重新编码音频”**

          * **对于当前文件的每一个音频轨道：**
              * **无论该音轨是否为用户选择的输出编码格式：**
                  * **步骤 1 (提取音频轨道):** 使用 FFmpeg 提取该音频轨道（`-map 0:a:N`）。
                  * **步骤 2 (重新编码为用户选择的格式):** 根据 **GUI 中用户设置的编码格式和参数**，将提取出的音频**强制重新编码**。
                  * **输出文件名：** 命名为 `原始文件名-音轨序号.新格式后缀`。
                  * **日志记录：** 记录成功信息，包括原始文件、音轨索引、最终输出文件名以及操作类型（“重新编码为 [格式]”）。

### 3\. 日志记录（详细）

  * **实时更新：** 日志应在 GUI 的日志显示区实时更新。
  * **记录内容：**
      * **成功记录：**
          * 操作开始时间。
          * 原始输入文件路径。
          * 处理的音轨索引和原始编码格式。
          * 执行的操作类型（“直接提取 AAC”、“无损提取”、“重新编码为 [格式]”）。
          * **成功生成的输出文件完整路径和文件名。**
          * 操作完成时间。
      * **失败记录：**
          * 操作时间。
          * 原始输入文件路径。
          * 导致失败的音轨索引（如果适用）。
          * **具体的错误信息**（例如 FFmpeg 错误码、文件不存在、参数无效等）。
          * 失败操作的类型。
  * **日志文件：** 除了 GUI 显示，日志也应同时写入一个可配置的日志文件（例如 `processing_log.txt`），方便后续查看。

### 4\. 错误处理

  * 当 FFmpeg 命令执行失败时，捕获错误输出，并在日志中记录失败信息和具体的错误原因。
  * 在 GUI 中提供友好的错误提示。

### 5\. 最终输出

  * 所有处理完成的编码音频文件都将以用户选择的格式封装，并命名为 `原始文件名-音轨序号.新格式后缀`。
  * 在特定情况下（“直接提取”且非 AAC 源的音轨），还会额外输出一个**原始编码格式的无损音频文件**，命名为 `原始文件名-音轨序号.原始后缀`。

-----

### 行为流程图概览（日志与多编码支持版）

```mermaid
graph TD
    A[开始] --> B{GUI: 文件选择 (多选)<br> + 输出选项/编码参数/日志显示};
    B --> C{GUI: 用户选择 '直接提取' / '重新编码'};

    subgraph 文件处理循环
        D{循环处理每个选定文件};
        D --> E{FFmpeg/ffprobe: 分析所有音频轨道,<br>判断AAC状态/原始编码格式/索引};
        E --> F{循环处理文件的每个音频轨道};

        subgraph 处理逻辑 (基于GUI选择和音轨分析)
            F --> G{GUI选项: '直接提取音频'?};
            G -- "是" --> H{当前音轨是 AAC 编码吗?};

            H -- "是 (含 AAC)" --> I[FFmpeg: 直接无损提取 AAC 音轨 (-map 0:a:N -c:a copy)];
            I --> S[命名: 文件名-音轨序号.m4a];
            S --> U[记录成功日志];
            U --> X{所有音轨处理完毕?};

            H -- "否 (不含 AAC)" --> J{GUI: 立即显示/启用编码参数设置区<br>+ 编码格式选择};
            J --> K[FFmpeg: 无损提取原始音轨 (-map 0:a:N -c:a copy) 到临时文件];
            K --> L[命名: 文件名-音轨序号.原始后缀];
            L --> M[记录原始无损提取日志];
            M --> N[FFmpeg: 使用用户选择的编码格式和参数，<br>对临时文件重新编码];
            N --> S;

            G -- "否 (选择 '重新编码音频')" --> P{GUI: 立即显示/启用编码参数设置区<br>+ 编码格式选择};
            P --> Q[FFmpeg: 提取音轨 (-map 0:a:N) 并使用用户选择的编码格式和参数，<br>强制重新编码];
            Q --> S;
        end

        X -- "否" --> F;
        X -- "是" --> Y{处理过程中发生错误吗?};
        Y -- "是" --> Z[记录失败日志];
        Y -- "否" --> D{下一个文件?};
    end
    D -- "否" --> AA[结束];
```

-----

这个流程图和描述现在涵盖了日志记录、多种输出编码格式、多音轨处理以及无损提取原始音频的复杂逻辑。在实现时，**错误处理**和**用户界面反馈**（如进度条、实时日志输出）将是提升用户体验的关键。
